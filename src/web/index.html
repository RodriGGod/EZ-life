<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EZLife Tool</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <div class="title-bar">
        <button class="btn-close" onclick="cerrarApp()">X</button>
    </div>

    <h1 style="margin-top: 10px;">EZLife</h1>
    <h4>by RodriGGod</h4>

    <div class="module-row">
        <div class="module-info">
            <div class="module-title">Browsers</div>
            <div class="module-desc">Web Executable Management</div>
            <div class="module-desc">
                Add ezlife browser to default apps to use it.
                <div class="copy-container">
                    <button id="btnCopyPath" class="btn-copy-path" onclick="copiarRuta()" data-path="...">
                        COPY PATH
                    </button>
                </div>
                <button class="btn-manual" style="margin-top: 5px; border-top: none; color: var(--accent);"
                    onclick="abrirDefaultApps()">
                    OPEN DEFAULT APPS
                </button>
            </div>

        </div>
        <div class="module-content">
            <div class="col-shortcut">
                <label>Input Trigger</label>
                <div class="input-wrapper">
                    <input type="text" id="atajoInput" value="..." readonly>
                    <button class="btn-record" id="btnGrabar" onclick="grabar()">REC</button>
                </div>
            </div>
            <div class="col-list">
                <label>Active Targets</label>
                <div class="scroll-list" id="listaNavegadores"></div>
                <button class="btn-manual" onclick="anadirManual()">+ LINK MANUAL .EXE</button>
            </div>
        </div>
    </div>

    <button class="btn-save" onclick="guardar()">INITIALIZE CONFIG</button>

    <script>
        let navegadoresGlobales = [];

        // Pywebview dispara este evento cuando está listo
        window.addEventListener('pywebviewready', async function () {
            const data = await window.pywebview.api.get_data_inicial();
            const config = data.config;

            // Configurar botón de copia
            if (data.browserPath) {
                const btn = document.getElementById('btnCopyPath');
                btn.setAttribute('data-path', data.browserPath);
            }

            document.getElementById('atajoInput').value = config.atajo || "alt gr+b";
            let listaSistema = data.sistema;
            let listaConfig = config.navegadores_activos || [];

            listaSistema.forEach(sis => {
                sis.checked = listaConfig.some(conf => conf.ruta === sis.ruta);
            });
            listaConfig.forEach(conf => {
                if (!listaSistema.some(s => s.ruta === conf.ruta)) {
                    conf.checked = true;
                    listaSistema.push(conf);
                }
            });

            navegadoresGlobales = listaSistema;
            renderizar();
        });

        function renderizar() {
            const container = document.getElementById('listaNavegadores');
            container.innerHTML = "";
            navegadoresGlobales.forEach((nav, index) => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `
                    <input type="checkbox" id="chk_${index}" ${nav.checked ? 'checked' : ''} onchange="toggleCheck(${index})">
                    <label for="chk_${index}" style="margin:0; cursor:pointer; flex:1;">
                        <span>${nav.nombre}</span>
                    </label>
                `;
                container.appendChild(div);
            });
        }

        function toggleCheck(index) {
            navegadoresGlobales[index].checked = !navegadoresGlobales[index].checked;
        }

        // Llamadas a Python (Fíjate en window.pywebview.api)
        async function grabar() {
            const btn = document.getElementById('btnGrabar');
            const input = document.getElementById('atajoInput');
            btn.classList.add('recording');
            input.value = "WAITING...";

            // Usamos setTimeout para que la UI se actualice antes de bloquear
            setTimeout(async () => {
                const teclas = await window.pywebview.api.grabar_atajo();
                input.value = teclas;
                btn.classList.remove('recording');
            }, 100);
        }

        async function anadirManual() {
            const nuevo = await window.pywebview.api.examinar_exe();
            if (nuevo) {
                nuevo.checked = true;
                navegadoresGlobales.push(nuevo);
                renderizar();
            }
        }

        async function guardar() {
            const atajo = document.getElementById('atajoInput').value;
            const activos = navegadoresGlobales.filter(n => n.checked).map(n => ({
                nombre: n.nombre, ruta: n.ruta
            }));

            if (activos.length === 0) { alert("⚠️ ERROR: TARGET MISSING"); return; }

            const ok = await window.pywebview.api.guardar_configuracion(atajo, activos);
            if (ok === true) {
                const btn = document.querySelector('.btn-save');
                const original = btn.innerText;
                btn.innerText = "SYSTEM UPDATED";
                setTimeout(() => btn.innerText = original, 1500);
            }
        }

        function cerrarApp() {
            window.pywebview.api.cerrar_app();
        }

        function abrirDefaultApps() {
            window.pywebview.api.open_default_apps();
        }

        function copiarRuta() {
            const btn = document.getElementById('btnCopyPath');
            const ruta = btn.getAttribute('data-path');
            if (ruta && ruta !== '...') {
                navigator.clipboard.writeText(ruta).then(() => {
                    const originalText = btn.innerText;
                    btn.innerText = "COPIED!";
                    setTimeout(() => btn.innerText = originalText, 1500);
                });
            }
        }
    </script>
</body>

</html>